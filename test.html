<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Zabuto Calendar with GitHub Files</title>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/zabuto_calendar/1.6.4/zabuto_calendar.min.css" />
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }
    </style>
</head>

<body>

    <h2>WESTNORTH Calendar</h2>
    <div id="my-calendar"></div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Zabuto Calendar -->
    <script src="js/calendar/zabuto_calendar.min.js"></script>
    <link rel="stylesheet" type="text/css" href="js/calendar/zabuto_calendar.css">

    <script>
        const owner = 'billy1125';
        const repo = 'billy1125.github.io';
        const path = 'diagram';

        async function getGitHubFileNames(owner, repo, path = '') {
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`GitHub API request failed: ${response.status}`);
                const data = await response.json();

                const svgFileDates = data
                    .map(item => item.name)
                    .filter(name => /^WESTNORTH_\d{8}\.svg$/.test(name))
                    .map(name => {
                        const dateStr = name.match(/_(\d{8})\.svg$/)[1];
                        const y = dateStr.substring(0, 4);
                        const m = dateStr.substring(4, 6);
                        const d = dateStr.substring(6, 8);
                        return `${y}-${m}-${d}`;
                    });

                const events = svgFileDates.map(date => ({
                    date: date,
                    badge: true,
                    title: "SVG available",
                    body: `<p>${date}.svg</p>`
                }));

                return events;
            } catch (error) {
                console.error('Error fetching GitHub files:', error);
                return [];
            }
        }

        $(document).ready(async function () {
            const events = await getGitHubFileNames(owner, repo, path);

            $("#my-calendar").zabuto_calendar({
                today: true,
                weekstartson: 0,
                language: "en",
                data: events, // ✅ 直接使用內嵌資料
                action: function () {
                    return myDateFunction(this.id, false);
                }
            });
        });

        // function myDateFunction(id, fromModal) {
        //     const date = $("#" + id).data("date");

        //     alert("你選擇了日期：" + date);
        //     return true;
        // }

        function myDateFunction(id, fromModal) {
            const date = $("#" + id).data("date");
            const formattedDate = date.replace(/-/g, ''); // 移除所有 "-"，得到 "20250607"
            // const rawDate = window.svgFiles?.[date];
            if (formattedDate) {
                const targetUrl = `show_svg.html?fileName=${formattedDate}`;
                window.open(targetUrl, '_blank');
            } else {
                alert('此日期沒有對應的 SVG 檔案。');
            }
            return true;
        }
    </script>

</body>

</html>